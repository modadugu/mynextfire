{% assign maxRelated = 3 %}
{% assign minCommonTags = 1 %}
{% assign maxRelatedCounter = 0 %}

{% for post in site.posts %}
  {% if post.url != page.url %}
    {% assign sameTagCount = 0 %}
    {% assign commonTags = '' %}
    {% for tag in post.tags %}
      {% if page.tags contains tag %}
        {% assign sameTagCount = sameTagCount | plus: 1 %}
      {% endif %}
    {% endfor %}
    {% if sameTagCount >= minCommonTags %}
      {% assign relatedPosts = relatedPosts | append: post.url | append: '|' | append: post.title | append: '||' %}
      {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
      {% if maxRelatedCounter >= maxRelated %}
        {% break %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if maxRelatedCounter > 0 %}
<div class="related-posts">
  <h3>Related Posts</h3>
  <ul>
    {% assign relatedArray = relatedPosts | split: '||' %}
    {% for item in relatedArray limit: maxRelated %}
      {% if item != '' %}
        {% assign parts = item | split: '|' %}
        <li><a href="{{ parts[0] | relative_url }}">{{ parts[1] }}</a></li>
      {% endif %}
    {% endfor %}
  </ul>
</div>
{% endif %}

